/**
 * @file page.tsx
 * @description –ì–ª–∞–≤–Ω–∞—è (–∏ –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–∞—è) —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è Smart Shopping List.
 *
 * –≠—Ç–æ Server Component ‚Äî –æ–Ω —Ä–µ–Ω–¥–µ—Ä–∏—Ç—Å—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ –ø—Ä–∏ –∫–∞–∂–¥–æ–º –∑–∞–ø—Ä–æ—Å–µ. –≠—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç:
 *   - –ú–æ–∂–Ω–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ –¥–µ–ª–∞—Ç—å –∑–∞–ø—Ä–æ—Å—ã –∫ –ë–î –Ω–∞–ø—Ä—è–º—É—é (–±–µ–∑ API-—Ä–æ—É—Ç–æ–≤).
 *   - –î–∞–Ω–Ω—ã–µ –Ω–µ —É—Ç–µ–∫–∞—é—Ç –Ω–∞ –∫–ª–∏–µ–Ω—Ç (Prisma Client-–∫–æ–¥ –Ω–µ–≤–∏–¥–∏–º –±—Ä–∞—É–∑–µ—Ä—É).
 *   - –°—Ç—Ä–∞–Ω–∏—Ü–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ –ø–æ –º–∞—Ä—à—Ä—É—Ç—É `/` (–∫–æ—Ä–µ–Ω—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è).
 *
 * –õ–æ–≥–∏–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã:
 *   1. –ß–∏—Ç–∞–µ–º —Å–µ—Å—Å–∏—é —á–µ—Ä–µ–∑ `auth()`.
 *   2. –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ù–ï –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω ‚Üí –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —ç–∫—Ä–∞–Ω –≤—Ö–æ–¥–∞.
 *   3. –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω ‚Üí –∑–∞–≥—Ä—É–∂–∞–µ–º –µ–≥–æ —Å–ø–∏—Å–∫–∏ –∏–∑ –ë–î
 *      –∏ –ø–µ—Ä–µ–¥–∞—ë–º –≤ –∫–ª–∏–µ–Ω—Ç—Å–∫–∏–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç `ListsContainer`.
 */

import prisma from "@/lib/db";
import { auth, signIn, signOut } from "@/auth";
import ListsContainer from "@/app/components/ListsContainer";

/**
 * –ö–æ–º–ø–æ–Ω–µ–Ω—Ç –≥–ª–∞–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã.
 *
 * Server Component: —Ä–µ–Ω–¥–µ—Ä–∏—Ç—Å—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ, –∏–º–µ–µ—Ç –¥–æ—Å—Ç—É–ø –∫ –ë–î –∏ —Å–µ—Å—Å–∏–∏.
 *
 * @returns JSX-—Ä–∞–∑–º–µ—Ç–∫–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å—Ç–∞—Ç—É—Å–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏:
 *   - –≠–∫—Ä–∞–Ω –≤—Ö–æ–¥–∞ —á–µ—Ä–µ–∑ Google ‚Äî –¥–ª—è –≥–æ—Å—Ç–µ–π.
 *   - –°–ø–∏—Å–æ–∫ –ø–æ–∫—É–ø–æ–∫ —Å –ø—Ä–æ—Ñ–∏–ª–µ–º ‚Äî –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.
 */
export default async function Home() {
  // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â—É—é —Å–µ—Å—Å–∏—é. –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∑–∞–ª–æ–≥–∏–Ω–µ–Ω ‚Äî session —Ä–∞–≤–Ω–∞ null.
  const session = await auth();

  // -----------------------------------------------------------------------
  // –°–¶–ï–ù–ê–†–ò–ô 1: –ì–û–°–¢–¨ (–Ω–µ –∑–∞–ª–æ–≥–∏–Ω–µ–Ω)
  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ª–µ–Ω–¥–∏–Ω–≥ —Å –∫–Ω–æ–ø–∫–æ–π –≤—Ö–æ–¥–∞ —á–µ—Ä–µ–∑ Google.
  // -----------------------------------------------------------------------
  if (!session || !session.user || !session.user.id) {
    return (
      <main className="flex min-h-screen flex-col items-center justify-center p-6 sm:p-24">
        <h1 className="text-3xl sm:text-4xl font-bold mb-6 sm:mb-8">
          Smart Shopping List üõí
        </h1>
        <p className="text-gray-500 mb-8">
          –í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã —Å–æ—Ö—Ä–∞–Ω—è—Ç—å —Å–≤–æ–∏ —Å–ø–∏—Å–∫–∏
        </p>

        {/*
         * –ö–Ω–æ–ø–∫–∞ –≤—Ö–æ–¥–∞ —á–µ—Ä–µ–∑ Google.
         * –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è Server Action: –¥–∏—Ä–µ–∫—Ç–∏–≤–∞ "use server" –≤–Ω—É—Ç—Ä–∏ action-–∞—Ç—Ä–∏–±—É—Ç–∞ —Ñ–æ—Ä–º—ã
         * –ø–æ–∑–≤–æ–ª—è–µ—Ç –≤—ã–∑–≤–∞—Ç—å —Å–µ—Ä–≤–µ—Ä–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é signIn –ø—Ä—è–º–æ –∏–∑ JSX.
         */}
        <form
          action={async () => {
            "use server";
            await signIn("google"); // –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ Google
          }}
        >
          <button className="bg-blue-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-blue-700 transition shadow-lg flex items-center gap-2">
            {/* SVG-–∏–∫–æ–Ω–∫–∞ –ª–æ–≥–æ—Ç–∏–ø–∞ Google */}
            <svg className="w-5 h-5" viewBox="0 0 24 24" fill="currentColor">
              <path
                d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"
                fill="#FFFFFF"
              />
              <path
                d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"
                fill="#FFFFFF"
              />
              <path
                d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"
                fill="#FFFFFF"
              />
              <path
                d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"
                fill="#FFFFFF"
              />
            </svg>
            –í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Google
          </button>
        </form>
      </main>
    );
  }

  // -----------------------------------------------------------------------
  // –°–¶–ï–ù–ê–†–ò–ô 2: –ê–í–¢–û–†–ò–ó–û–í–ê–ù–ù–´–ô –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–¨
  // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–∫–∏ –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.
  // -----------------------------------------------------------------------

  /**
   * –ó–∞–≥—Ä—É–∂–∞–µ–º –≤—Å–µ —Å–ø–∏—Å–∫–∏, –¥–æ—Å—Ç—É–ø–Ω—ã–µ —Ç–µ–∫—É—â–µ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é:
   * - –°–ø–∏—Å–∫–∏, –≥–¥–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —è–≤–ª—è–µ—Ç—Å—è –≤–ª–∞–¥–µ–ª—å—Ü–µ–º (ownerId === session.user.id).
   * - –°–ø–∏—Å–∫–∏, –∫ –∫–æ—Ç–æ—Ä—ã–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–∏–ª–∏ —Å–æ–≤–º–µ—Å—Ç–Ω—ã–π –¥–æ—Å—Ç—É–ø (sharedWith).
   *
   * `include` –ø–æ–¥–≥—Ä—É–∂–∞–µ—Ç —Å–≤—è–∑–∞–Ω–Ω—ã–µ –∑–∞–ø–∏—Å–∏ –∏–∑ –¥—Ä—É–≥–∏—Ö —Ç–∞–±–ª–∏—Ü –æ–¥–Ω–∏–º SQL-–∑–∞–ø—Ä–æ—Å–æ–º (JOIN).
   */
  const allLists = await prisma.shoppingList.findMany({
    where: {
      OR: [
        { ownerId: session.user.id }, // –Ø –≤–ª–∞–¥–µ–ª–µ—Ü
        { sharedWith: { some: { id: session.user.id } } }, // –ú–Ω–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω –¥–æ—Å—Ç—É–ø
      ],
    },
    include: {
      items: {
        orderBy: {
          createdAt: "asc", // –¢–æ–≤–∞—Ä—ã –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã –æ—Ç —Å—Ç–∞—Ä—ã—Ö –∫ –Ω–æ–≤—ã–º
        },
        include: {
          addedBy: {
            select: { id: true, name: true, email: true },
          },
        },
      },
      owner: true, // –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≤–ª–∞–¥–µ–ª—å—Ü–µ (–¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è "–°–æ–∑–¥–∞–Ω–æ: X")
      sharedWith: true, // –°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å –¥–æ—Å—Ç—É–ø–æ–º (–¥–ª—è –±–ª–æ–∫–∞ "–ü–æ–¥–µ–ª–∏—Ç—å—Å—è")
    },
  });

  return (
    <main className="p-4 sm:p-10 max-w-xl mx-auto">
      {/* –®–∞–ø–∫–∞: –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, email –∏ –∫–Ω–æ–ø–∫–∞ –≤—ã—Ö–æ–¥–∞ */}
      <div className="flex justify-between items-center mb-8">
        <div>
          <h1 className="text-2xl font-bold">
            –ü—Ä–∏–≤–µ—Ç, {session.user.name}! üëã
          </h1>
          <p className="text-gray-500 text-sm">{session.user.email}</p>
        </div>

        {/*
         * –ö–Ω–æ–ø–∫–∞ –≤—ã—Ö–æ–¥–∞ –∏–∑ —Å–∏—Å—Ç–µ–º—ã.
         * –ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ –∫–Ω–æ–ø–∫–µ –≤—Ö–æ–¥–∞ ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è Server Action –≤–Ω—É—Ç—Ä–∏ —Ñ–æ—Ä–º—ã.
         */}
        <form
          action={async () => {
            "use server";
            await signOut();
          }}
        >
          <button className="text-sm text-red-500 hover:underline">
            –í—ã–π—Ç–∏
          </button>
        </form>
      </div>

      {/*
       * –ö–ª–∏–µ–Ω—Ç—Å–∫–∏–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç —Å–æ –≤—Å–µ–º–∏ —Å–ø–∏—Å–∫–∞–º–∏.
       * –ü—Ä–∏–Ω–∏–º–∞–µ—Ç –Ω–∞—á–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Å —Å–µ—Ä–≤–µ—Ä–∞ –∏ —Å–∞–º —É–ø—Ä–∞–≤–ª—è–µ—Ç
       * –æ–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω—ã–º–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è–º–∏ –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ.
       */}
      <ListsContainer
        allLists={allLists}
        currentUserId={session.user.id}
        currentUserName={session.user.name ?? null}
        currentUserEmail={session.user.email ?? ""}
      />
    </main>
  );
}
